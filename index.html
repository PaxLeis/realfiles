<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>realfiles</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  overflow: hidden;
  background:#222;
  color:#eee;
}
#toolbar {
  background:#333; padding:10px; display:flex; gap:10px; flex-wrap:wrap;
}
button {
  background:#555; color:#fff; border:none; padding:8px 12px; cursor:pointer; border-radius:4px;
}
button:hover {
  background:#777;
}
#container {
  position: relative; width:100%; height: calc(100vh - 50px);
  display:flex; overflow:hidden;
}
#filetree {
  width:250px; background:#111; overflow:auto; padding:10px;
}
#filetree .folder, #filetree .file {
  padding:4px 8px; margin:2px 0; background:#222; border-radius:4px; cursor:pointer;
}
#filetree .folder:hover, #filetree .file:hover {
  background:#444;
}
#editorContainer {
  flex:1; display:flex; flex-direction:column; height:100%;
}
#tabBar {
  display:flex; background:#333; padding:5px;
}
#tabBar div {
  padding:5px 10px; margin-right:5px; background:#555; border-radius:3px; cursor:pointer;
}
#tabBar .active {
  background:#888;
}
#editorArea {
  flex:1; display:flex; flex-direction:column;
}
#code {
  flex:1; width:100%; resize:none; padding:10px; font-family: monospace; font-size:14px; background:#222; color:#eee; border:none; outline:none;
}
#saveBtn, #openBtn, #deleteBtn {
  padding:8px 12px; margin:10px; background:#555; border:none; border-radius:4px; cursor:pointer;
}
#saveBtn:hover, #openBtn:hover, #deleteBtn:hover {
  background:#777;
}
#openBtn {
  display:none; /* hidden by default, shown when file is selected */
}
</style>
</head>
<body>

<div id="toolbar">
  <button onclick="addFolder()">Add Folder</button>
  <button onclick="addFile()">Add File</button>
  <button onclick="saveFiles()">Save</button>
  <button onclick="loadFiles()">Load</button>
  <button id="openBtn" onclick="openFileInBlob()">Open</button>
  <button onclick="deselectFile()">Deselect</button>
  <button onclick="triggerFileUpload()">Upload File</button>
  <button id="deleteBtn" onclick="deleteSelected()" disabled>Delete</button>
</div>

<div id="container">
  <div id="filetree"></div>
  <div id="editorContainer">
    <div id="tabBar">
      <div id="htmlTab" class="active" onclick="switchTab('html')">HTML</div>
      <div id="cssTab" onclick="switchTab('css')">CSS</div>
      <div id="jsTab" onclick="switchTab('js')">JS</div>
    </div>
    <div id="editorArea">
      <textarea id="code"></textarea>
      <button id="saveCodeBtn" onclick="saveCode()">Save Code</button>
    </div>
  </div>
</div>

<script>
/* Data structure for folders/files with code */
let root = {
  name: 'root',
  type: 'folder',
  children: []
};
let currentFile = null; // the file object being edited
let currentFolderOrFile = null; // the selected folder or file
let currentTab='html';

// Helper functions
function createFolder(name) {
  return { name, type:'folder', children:[] };
}
function createFile(name) {
  return {
    name,
    type:'file',
    code: { html:'', css:'', js:'' }
  };
}

const filetreeDiv = document.getElementById('filetree');
const openButton = document.getElementById('openBtn');
const deleteButton = document.getElementById('deleteBtn');

let dragSrcEl = null; // For tracking the source element during drag

// Rendering file tree
function renderTree(node, parentEl) {
  parentEl.innerHTML='';
  function recurse(node, el) {
    node.children.forEach(child => {
      const div = document.createElement('div');
      div.textContent = child.name + (child.type==='folder'?' [Folder]':' [File]');
      // Add draggable attribute
      div.setAttribute('draggable', 'true');

      // Drag events
      div.addEventListener('dragstart', (e) => {
        dragSrcEl = { item: child, element: div };
        e.dataTransfer.setData('text/plain', ''); // for Firefox compatibility
      });

      // Drag over event to allow drop
      div.addEventListener('dragover', (e) => {
        e.preventDefault();
        // Highlight potential drop target
        if (child.type==='folder') {
          div.style.background='#666';
        }
      });
      div.addEventListener('dragleave', (e) => {
        // Remove highlight
        div.style.background='#222';
      });

      // Drop event
      div.addEventListener('drop', (e) => {
        e.preventDefault();
        if (child.type==='folder') {
          // Move the dragged item into this folder
          if (dragSrcEl && dragSrcEl.item !== child && !isDescendant(dragSrcEl.item, child)) {
            // Remove from old parent
            const oldParent = findParent(root, dragSrcEl.item);
            if (oldParent) {
              oldParent.children = oldParent.children.filter(c => c !== dragSrcEl.item);
            }
            // Add into new folder
            child.children.push(dragSrcEl.item);
            renderTree(root, parentEl);
          }
        }
        // Remove highlight after drop
        div.style.background='#222';
      });

      // Context menu or double click for delete could be added here if needed

      if (child.type==='folder') {
        div.className='folder';
        div.onclick=()=> {
          selectItem(child, div);
          // Toggle display of sublist
          if (div.nextSibling && div.nextSibling.style.display==='none') {
            div.nextSibling.style.display='block';
          } else if (div.nextSibling) {
            div.nextSibling.style.display='none';
          } else {
            const sublist = document.createElement('div');
            sublist.style.paddingLeft='15px';
            recurse(child, sublist);
            parentEl.insertBefore(sublist, div.nextSibling);
          }
        };
        parentEl.appendChild(div);
      } else {
        div.className='file';
        div.onclick=()=> {
          selectItem(child, div);
          openFile(child);
        };
        parentEl.appendChild(div);
      }
    });
  }
  recurse(node, parentEl);
}

// Helper to find parent node
function findParent(node, target) {
  if (!node.children) return null;
  for (let c of node.children) {
    if (c === target) return node;
    if (c.type==='folder') {
      const res = findParent(c, target);
      if (res) return res;
    }
  }
  return null;
}

// Helper to check if a node is a descendant of another (to prevent moving into own subtree)
function isDescendant(child, parent) {
  if (child === parent) return true;
  if (parent.type==='folder') {
    return parent.children.some(c => isDescendant(child, c));
  }
  return false;
}

// Selection handling
function selectItem(item, elementDiv) {
  if (currentFolderOrFile && currentFolderOrFile.element) {
    currentFolderOrFile.element.style.background='#222';
  }
  currentFolderOrFile = { item: item, element: elementDiv };
  elementDiv.style.background='#666';
  document.getElementById('deleteBtn').disabled=false;
}

// Add Folder
function addFolder() {
  const name=prompt('Folder name:', 'New Folder');
  if (name) {
    root.children.push(createFolder(name));
    renderTree(root, filetreeDiv);
  }
}

// Add File
function addFile() {
  const name=prompt('File name:', 'NewFile.html');
  if (name) {
    root.children.push(createFile(name));
    renderTree(root, filetreeDiv);
  }
}

function findNodeByPath(pathArray) {
  let node = root;
  for(let p of pathArray) {
    node = node.children.find(c=>c.name===p);
    if (!node) break;
  }
  return node;
}

// Open file
function openFile(file) {
  currentFile = file;
  document.getElementById('code').value = file.code[currentTab] || '';
  document.getElementById('openBtn').style.display='inline-block';
}

// Deselect file
function deselectFile() {
  currentFile = null;
  currentFolderOrFile = null;
  document.getElementById('code').value='';
  document.getElementById('openBtn').style.display='none';
  if (currentFolderOrFile && currentFolderOrFile.element) {
    currentFolderOrFile.element.style.background='#222';
  }
  document.getElementById('deleteBtn').disabled=true;
}

// Open in blob
function openFileInBlob() {
  if (!currentFile) return;
  const htmlContent = `
  <!DOCTYPE html>
  <html>
  <head>
    <style>${currentFile.code.css || ''}</style>
  </head>
  <body>
    ${currentFile.code.html || ''}
    <script>${currentFile.code.js || ''}<\/script>
  </body>
  </html>`;
  const blob = new Blob([htmlContent], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  window.open(url);
}

// Save code
function saveCode() {
  if (currentFile) {
    currentFile.code[currentTab]=document.getElementById('code').value;
  }
}

// Switch tabs
function switchTab(tab) {
  currentTab=tab;
  document.querySelectorAll('#tabBar div').forEach(div=>{
    div.className=div.id===tab+'Tab'?'active':'';
  });
  if (currentFile) {
    document.getElementById('code').value = currentFile.code[currentTab] || '';
  }
}

// Save & load
function saveFiles() {
  localStorage.setItem('fileStructure', JSON.stringify(root));
  alert('Saved!');
}
function loadFiles() {
  const data=localStorage.getItem('fileStructure');
  if (data) {
    root=JSON.parse(data);
    renderTree(root, filetreeDiv);
    currentFile=null;
    document.getElementById('code').value='';
    document.getElementById('openBtn').style.display='none';
    if (currentFolderOrFile && currentFolderOrFile.element) {
      currentFolderOrFile.element.style.background='#222';
    }
    document.getElementById('deleteBtn').disabled=true;
  } else {
    alert('No saved data');
  }
}

// File upload
function triggerFileUpload() {
  document.getElementById('fileUploader').click();
}
function handleFileUpload(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const content = e.target.result;
      const newFile = createFile(file.name);
      if (file.name.endsWith('.html')) {
        newFile.code.html = content;
      } else if (file.name.endsWith('.css')) {
        newFile.code.css = content;
      } else if (file.name.endsWith('.js')) {
        newFile.code.js = content;
      } else {
        newFile.code.content = content;
      }
      root.children.push(newFile);
      renderTree(root, filetreeDiv);
    };
    reader.readAsText(file);
  }
  event.target.value = '';
}

// Delete selected item
function deleteSelected() {
  if (!currentFolderOrFile || !currentFolderOrFile.item) return;
  if (confirm('Are you sure you want to delete this?')) {
    function removeNode(parent, node) {
      parent.children = parent.children.filter(c => c !== node);
    }
    function findParent(node, target) {
      if (!node.children) return null;
      for (let c of node.children) {
        if (c === target) return node;
        if (c.type==='folder') {
          const res = findParent(c, target);
          if (res) return res;
        }
      }
      return null;
    }
    const parent = findParent(root, currentFolderOrFile.item);
    if (parent) {
      removeNode(parent, currentFolderOrFile.item);
      renderTree(root, filetreeDiv);
    }
    deselectFile();
  }
}

// Initialize the tree
renderTree(root, filetreeDiv);
switchTab('html');

// Load data on page load
window.onload = function() {
  loadFiles();
};

// Auto-save
setInterval(() => {
  localStorage.setItem('fileStructure', JSON.stringify(root));
  console.log('Auto-saved at', new Date().toLocaleTimeString());
}, 5000);
window.addEventListener('beforeunload', () => { saveFiles(); });
</script>
</body>
</html>
